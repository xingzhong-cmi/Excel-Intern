# Excel Auto Handle - 系统架构

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Excel Auto Handle                         │
│                    智能Excel处理系统                              │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                          用户层                                   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │  上传文件 │  │  输入指令 │  │  查看结果 │  │  查看日志 │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────────────────────────────────────────────────────┘
        │              │              │              │
        ▼              ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        主程序层 (main.py)                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 1. 初始化模块                                              │  │
│  │    - 创建目录                                              │  │
│  │    - 加载配置                                              │  │
│  │    - 设置日志                                              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 2. 文件扫描模块                                            │  │
│  │    - 扫描uploads目录                                       │  │
│  │    - 读取文件元数据                                        │  │
│  │    - 显示文件信息                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 3. 交互模块                                                │  │
│  │    - 接收用户指令                                          │  │
│  │    - 处理特殊命令                                          │  │
│  │    - 验证指令有效性                                        │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 4. API调用模块                                             │  │
│  │    - 构建提示词                                            │  │
│  │    - 调用DeepSeek API                                     │  │
│  │    - 解析返回脚本                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 5. 安全验证模块                                            │  │
│  │    - 检测危险代码                                          │  │
│  │    - 验证文件操作                                          │  │
│  │    - 白名单检查                                            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 6. 脚本执行模块                                            │  │
│  │    - 保存脚本到temp                                        │  │
│  │    - 执行脚本                                              │  │
│  │    - 捕获错误                                              │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 7. 清理模块                                                │  │
│  │    - 清理temp文件                                          │  │
│  │    - 记录日志                                              │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
        │              │              │              │
        ▼              ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Excel函数层 (excel_functions/)                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │   CRUD   │  │   Query  │  │Statistics│  │  Merge   │        │
│  │  crud.py │  │ query.py │  │stats.py  │  │ merge.py │        │
│  │  7个函数  │  │  5个函数  │  │  8个函数  │  │  4个函数  │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────────────────────────────────────────────────────┘
        │              │              │              │
        ▼              ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据处理层                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                      │
│  │  pandas  │  │ openpyxl │  │   xlrd   │                      │
│  └──────────┘  └──────────┘  └──────────┘                      │
└─────────────────────────────────────────────────────────────────┘
        │              │              │
        ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        存储层                                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │  uploads │  │  results │  │   temp   │  │   logs   │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      外部服务层                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │               DeepSeek API                                │  │
│  │   - 接收用户指令和上下文                                    │  │
│  │   - 生成Python处理脚本                                     │  │
│  │   - 返回可执行代码                                         │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流图

```
用户指令
    │
    ▼
┌───────────────────┐
│ 扫描Excel文件信息   │
│ - 文件名           │
│ - 工作表          │
│ - 表头            │
│ - 数据预览        │
└───────────────────┘
    │
    ▼
┌───────────────────┐
│ 获取函数库信息     │
│ - 24个函数        │
│ - 功能说明        │
│ - 参数说明        │
└───────────────────┘
    │
    ▼
┌───────────────────┐
│ 构建API请求       │
│ - 文件信息        │
│ - 函数信息        │
│ - 用户指令        │
│ - 生成要求        │
└───────────────────┘
    │
    ▼
┌───────────────────┐
│ 调用DeepSeek API  │
│ - 发送请求        │
│ - 接收响应        │
│ - 提取代码        │
└───────────────────┘
    │
    ▼
┌───────────────────┐
│ 安全验证          │
│ - 危险代码检测    │
│ - 文件操作检查    │
│ - 白名单验证      │
└───────────────────┘
    │
    ├─ 不通过 → 提示用户重新输入
    │
    ▼ 通过
┌───────────────────┐
│ 保存脚本          │
│ - 生成文件名      │
│ - 保存到temp/     │
└───────────────────┘
    │
    ▼
┌───────────────────┐
│ 执行脚本          │
│ - import函数库    │
│ - 读取Excel       │
│ - 执行操作        │
│ - 保存结果        │
└───────────────────┘
    │
    ├─ 失败 → 显示错误，记录日志
    │
    ▼ 成功
┌───────────────────┐
│ 生成结果文件       │
│ - 保存到results/  │
│ - 格式化文件名    │
│ - 显示成功消息    │
└───────────────────┘
    │
    ▼
┌───────────────────┐
│ 清理临时文件       │
│ - 删除temp脚本    │
│ - 记录日志        │
└───────────────────┘
    │
    ▼
  完成
```

## 模块依赖关系

```
main.py
  │
  ├─ python-dotenv (配置管理)
  │    └─ config/.env
  │
  ├─ logging (日志系统)
  │    └─ logs/*.log
  │
  ├─ requests (API调用)
  │    └─ DeepSeek API
  │
  └─ excel_functions (Excel处理)
       │
       ├─ crud.py
       │    └─ pandas, openpyxl
       │
       ├─ query.py
       │    └─ pandas
       │
       ├─ statistics.py
       │    └─ pandas
       │
       └─ merge.py
            └─ pandas, openpyxl
```

## 安全机制

```
脚本接收
    │
    ▼
┌──────────────────────────┐
│ 第一层：语法检查          │
│ - 代码是否可解析          │
└──────────────────────────┘
    │
    ▼
┌──────────────────────────┐
│ 第二层：危险模块检测      │
│ - import os              │
│ - import subprocess      │
│ - import sys             │
│ - __import__             │
└──────────────────────────┘
    │
    ▼
┌──────────────────────────┐
│ 第三层：危险函数检测      │
│ - eval()                │
│ - exec()                │
│ - compile()             │
│ - open() (文件操作)      │
└──────────────────────────┘
    │
    ▼
┌──────────────────────────┐
│ 第四层：文件操作保护      │
│ - 禁止删除uploads文件    │
│ - 禁止修改系统文件       │
└──────────────────────────┘
    │
    ├─ 检测到风险 → 拒绝执行
    │
    ▼ 安全
  允许执行
```

## 错误处理机制

```
各层级错误处理：

1. 配置层
   ├─ 文件不存在 → 提示创建配置文件
   ├─ API Key无效 → 提示检查密钥
   └─ 格式错误 → 显示配置示例

2. 文件层
   ├─ 文件不存在 → 提示文件路径
   ├─ 格式不支持 → 显示支持的格式
   └─ 读取失败 → 显示具体错误

3. API层
   ├─ 网络错误 → 提示检查网络
   ├─ 超时 → 增加timeout建议
   ├─ 密钥错误 → 提示检查配置
   └─ 返回为空 → 重新生成

4. 执行层
   ├─ 语法错误 → 显示错误位置
   ├─ 函数调用错误 → 显示参数问题
   └─ 运行时错误 → 显示堆栈跟踪

5. 日志层
   └─ 所有错误记录到日志文件
```

## 扩展点

系统设计了多个扩展点，便于功能增强：

### 1. 函数扩展
```
excel_functions/
  └─ new_module.py  # 新增功能模块
       │
       ├─ 添加新函数
       └─ 在__init__.py中导出
```

### 2. 安全规则扩展
```
main.py
  └─ validate_script_security()
       └─ 添加新的检测规则
```

### 3. API提示词扩展
```
main.py
  └─ call_deepseek_api()
       └─ 修改prompt模板
```

### 4. 日志格式扩展
```
main.py
  └─ setup_logging()
       └─ 自定义日志格式
```

## 性能优化点

1. **文件缓存**：缓存已读取的文件信息
2. **分块处理**：大文件分块读取和处理
3. **并行执行**：支持多文件并行处理
4. **结果预览**：执行前预览结果
5. **增量更新**：仅更新变化的部分

## 总结

Excel Auto Handle 采用分层架构设计：
- **用户层**：提供简洁的交互界面
- **主程序层**：协调各模块工作
- **函数层**：提供24个专业的Excel处理函数
- **数据层**：使用成熟的pandas/openpyxl库
- **存储层**：清晰的目录结构

系统特点：
- ✅ 模块化设计，易于维护和扩展
- ✅ 完善的错误处理和日志记录
- ✅ 多层安全验证机制
- ✅ 清晰的数据流和依赖关系
